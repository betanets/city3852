<!DOCTYPE html>
<html layout:decorate="~{base}">
    <head>
        <link rel="stylesheet" href="https://openlayers.org/en/v4.4.2/css/ol.css" type="text/css">
        <script type="text/javascript" src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
        <script type="text/javascript" src="https://openlayers.org/en/v4.4.2/build/ol.js"></script>
        <title>7Bus - Главная страница</title>
    </head>
    <body>
        <section layout:fragment="content">
            <div id="map" class="map">
            </div>
            <div id="stationsContent">
                <table style="display: none">
                    <tbody id="stations-body">
                        <tr th:if="${stations.empty}">
                            <td>No stations</td>
                        </tr>
                        <tr th:each="station : ${stations}" th:data-sid="${station.stationId}" th:data-type="${station.stationType}" th:data-lat="${station.latitude}" th:data-lon="${station.longtitude}">
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="markersContent">
                <!-- markers content is in markers.html -->
            </div>
        
            <script th:inline="javascript">
                var iconStyle = new ol.style.Style({
                  image: new ol.style.Icon(({
                    anchor: [0.5, 46],
                    anchorXUnits: 'fraction',
                    anchorYUnits: 'pixels',
                    src: 'https://openlayers.org/en/v4.4.2/examples/data/icon.png'
                  }))
                });

                var vectorSource = new ol.source.Vector({});
                
                $("#stations-body").children().each(function(index){
                    var lat = $(this).data("lat");
                    var lon = $(this).data("lon");
                    
                    var iconFeature = new ol.Feature({
                        geometry: new ol.geom.Point(new ol.proj.fromLonLat([lon / 1000000, lat / 1000000])),
                        population: 4000,
                        rainfall: 500
                    });
                    iconFeature.set('station_id', $(this).data("sid"));
                    iconFeature.set('station_type', $(this).data("type"));
                    iconFeature.setStyle(iconStyle);
                    
                    vectorSource.addFeature(iconFeature);
                });
                
                var vectorLayer = new ol.layer.Vector({
                  source: vectorSource
                });
                
                var map = new ol.Map({
                    layers: [
                        new ol.layer.Tile({
                            source: new ol.source.OSM()
                        }),
                        vectorLayer
                    ],
                    target: 'map',
                    view: new ol.View({
                        center: new ol.proj.fromLonLat([83.7625, 53.3502]),
                        zoom: 14
                    })
                });
                
                //image style
                var icon = new ol.style.Icon(({
                    src: "/resources/img/bus.png"
                }));
                icon.load();
                
                //triangle style
                //var stroke = new ol.style.Stroke({color: 'red', width: 1});
                //var fill = new ol.style.Fill({color: 'yellow'});
                
                var imageStyle = new ol.style.Style({
                    /*image: new ol.style.RegularShape({
                        fill: fill,
                        stroke: stroke,
                        points: 3,
                        radius: 15,
                        //rotation: dir * (Math.PI / 180),
                        angle: 0
                    }),*/
                    image: icon
                });
                
                //circle style
                /*
                var imageStyle = new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 12,
                        snapToPixel: false,
                        fill: new ol.style.Fill({color: 'yellow'}),
                        stroke: new ol.style.Stroke({color: 'red', width: 1})
                    })
                });*/
    
                //Modal show event
                map.on('click', function(evt) {
                    var feature = map.forEachFeatureAtPixel(evt.pixel,
                        function(feature) {
                          return feature;
                        });
                    if (feature) {
                        console.log(feature.get('station_id'));
                        console.log(feature.get('station_type'));
                    }
                });
                
                //Hide stations on zoom level
                map.on('moveend', function(e) {
                    zoom = map.getView().getZoom();
                    if (zoom >= 16) {
                       vectorLayer.setVisible(true);
                    }
                    else {
                       vectorLayer.setVisible(false);
                    }
                });
            </script>
        </section>
    </body>
</html>